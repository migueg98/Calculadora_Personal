<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Cuadrantes Hostelería — Semana</title>
<style>
body{font-family:system-ui,Segoe UI,Arial;margin:20px;max-width:1200px}
textarea,input,button{font-size:14px;padding:8px;margin:6px 0}
label{font-weight:600;margin-top:12px;display:block}
section.day{border:1px solid #eee;padding:12px;border-radius:10px;margin:10px 0}
section.day h3{margin:0 0 6px 0}
.small{width:160px}
.inline{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.slots{margin-top:8px}
.slot-row{display:flex;gap:10px;align-items:center;padding:6px 0;border-bottom:1px dashed #eee}
.slot-row:last-child{border-bottom:none}
.slot-row label{min-width:120px}
.btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
table{border-collapse:collapse;width:100%;margin-top:16px}
th,td{border:1px solid #e3e3e3;padding:8px;text-align:center}
th{background:#fafafa;font-weight:700}
td.emp{font-weight:600;text-align:left}
td.hit{background:#f3fbf3}
.warn{background:#fff9e6;border:1px solid #ffe08a;padding:10px;margin-top:10px;white-space:pre-wrap}
.help{color:#555;font-size:13px;margin:8px 0}
hr{border:none;border-top:1px solid #eee;margin:12px 0}
</style>
</head>
<body>
  <h1>Cuadrantes — Semana (reglas duras)</h1>
  <p class="help">
    Para cada día, escribe las <b>marcas horarias</b> (horas separadas por coma) y pulsa <b>Generar franjas</b>. Se crearán las franjas adyacentes
    (ej: <i>11:00,13:00,16:00 → 11:00–13:00; 13:00–16:00</i>). Marca las franjas que se usan y define su <b>mínimo</b>.
  </p>

  <!-- Config general -->
  <section class="inline" style="justify-content:space-between;align-items:flex-end">
    <div>
      <label>Empleados (IDs separados por coma)</label>
      <input id="emps" style="width:520px" value="E1,E2,E3,E4,E5,E6,E7,E8,E9,E10,E11,E12,E13,E14,E15">
    </div>
    <div>
      <label>Objetivo horas/empleado</label>
      <input id="target" class="small" value="40">
    </div>
    <div>
      <label>Tolerancia ±h</label>
      <input id="tol" class="small" value="2">
    </div>
    <div>
      <label>Máx. horas/día</label>
      <input id="maxDay" class="small" value="10">
    </div>
    <div>
      <label>Máx. bloques/día</label>
      <input id="maxBlocks" class="small" value="2">
    </div>
  </section>

  <hr>

  <!-- Días -->
  <div id="days"></div>

  <div class="btns">
    <button id="calcWeek">Calcular semana (reglas duras)</button>
  </div>

  <div id="tableWrap"></div>
  <div id="warnings" class="warn" style="display:none"></div>

<script>
const DAYS_EN = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
const DAYS_ES = ["Lun","Mar","Mié","Jue","Vie","Sáb","Dom"];

// ----- Utilidades de tiempo -----
function normTime(t){
  // Normaliza "24:00" a "23:59"
  const [h,m] = t.split(':').map(n=>parseInt(n||'0',10));
  if (h===24 && (m||0)===0) return "23:59";
  return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
}
function minutes(t){
  const [h,m] = t.split(':').map(Number);
  if (h===24 && m===0) return 24*60-1;
  return h*60+m;
}
function hoursBetween(a,b){
  return Math.max(0,(minutes(b)-minutes(a)))/60.0;
}

// ----- Generar franjas desde marcas -----
function genSlotsFromMarks(marksStr){
  // admite "11:00,13:00,16:00" o con espacios; ordena y quita duplicados
  const parts = marksStr.split(/[,;\s]+/).map(x=>x.trim()).filter(Boolean).map(normTime);
  const uniq = Array.from(new Set(parts)).sort((a,b)=>minutes(a)-minutes(b));
  const out = [];
  for (let i=0;i<uniq.length-1;i++){
    out.push({start: uniq[i], end: uniq[i+1]});
  }
  return out;
}

// ----- UI por día -----
function daySection(dayIdx){
  const en = DAYS_EN[dayIdx], es = DAYS_ES[dayIdx];
  const sec = document.createElement('section');
  sec.className = 'day';
  sec.dataset.day = en;
  sec.innerHTML = `
    <h3>${es} <span style="font-weight:400;color:#777">(${en})</span></h3>
    <div class="inline">
      <label>Marcas horarias (coma)</label>
      <input class="marks" style="width:420px" value="11:00,13:00,16:00,18:00,20:00,23:59">
      <label style="margin-left:8px">Cerrado</label>
      <input type="checkbox" class="closed">
      <button class="gen">Generar franjas</button>
    </div>
    <div class="slots"></div>
  `;
  // eventos
  sec.querySelector('.gen').onclick = ()=>{
    renderSlots(sec);
  };
  sec.querySelector('.closed').onchange = ()=>{
    const closed = sec.querySelector('.closed').checked;
    sec.querySelector('.marks').disabled = closed;
    sec.querySelector('.gen').disabled = closed;
    sec.querySelector('.slots').innerHTML = closed ? '<div style="color:#999">Día cerrado</div>' : '';
  };
  return sec;
}

function renderSlots(section){
  const cont = section.querySelector('.slots');
  cont.innerHTML = '';
  const closed = section.querySelector('.closed').checked;
  if (closed){ cont.innerHTML = '<div style="color:#999">Día cerrado</div>'; return; }
  const marksStr = section.querySelector('.marks').value.trim();
  const slots = genSlotsFromMarks(marksStr);
  if (!slots.length){
    cont.innerHTML = '<div style="color:#999">Añade al menos dos marcas para generar franjas.</div>';
    return;
  }
  // pintar cada franja con checkbox y mínimo
  for (const sl of slots){
    const row = document.createElement('div');
    row.className = 'slot-row';
    row.innerHTML = `
      <input type="checkbox" class="use" checked>
      <label>${sl.start} — ${sl.end}</label>
      <span>Min:</span>
      <input type="number" class="min" value="0" min="0" style="width:80px">
    `;
    row.dataset.start = sl.start;
    row.dataset.end = sl.end;
    cont.appendChild(row);
  }
}

// ----- Construir payload semana desde la UI -----
function collectWeekPayload(){
  const target   = parseFloat(document.getElementById('target').value || '40');
  const tol      = parseFloat(document.getElementById('tol').value || '2');
  const maxDay   = parseFloat(document.getElementById('maxDay').value || '10');
  const maxBlocks= parseInt(document.getElementById('maxBlocks').value || '2',10);
  const empsTxt  = document.getElementById('emps').value.trim();
  const employees = empsTxt.split(',').map(id=>({
    id: id.trim(),
    target_hours: target,
    max_hours_per_day: maxDay,
    max_blocks_per_day: maxBlocks,
    availability: {} // se rellena por día abajo
  })).filter(e=>e.id);

  const slots = [];
  const mins  = [];

  document.querySelectorAll('section.day').forEach(sec=>{
    const day = sec.dataset.day;
    const closed = sec.querySelector('.closed').checked;
    if (closed) return;

    const rows = sec.querySelectorAll('.slot-row');
    // construir disponibilidad global del día para todos los empleados como el rango más amplio marcado
    // (opción simple: si hay slots seleccionados, disponibilidad desde el primer inicio al último fin)
    const selected = Array.from(rows).filter(r=>r.querySelector('.use').checked);
    if (selected.length){
      const firstStart = selected[0].dataset.start;
      const lastEnd = selected[selected.length-1].dataset.end;
      for (const e of employees){
        e.availability[day] = [{start:firstStart, end:lastEnd}];
      }
    }
    // slots seleccionados + min por slot
    for (const r of rows){
      const use = r.querySelector('.use').checked;
      if (!use) continue;
      const s = r.dataset.start, e = r.dataset.end;
      const m = parseInt(r.querySelector('.min').value || '0',10);
      slots.push({day, start:s, end:e});
      mins.push(m);
    }
  });

  return {employees, slots, mins, tol};
}

// ----- Render matriz resultado -----
function renderMatrix(emps, slotsV2, assignments){
  // días en orden
  const days = DAYS_EN;
  const mapIdx = Object.fromEntries(emps.map((e,i)=>[e.id,i]));
  const hrs = Array.from({length: emps.length}, ()=>Object.fromEntries(days.map(d=>[d,0])));
  const total = new Array(emps.length).fill(0);

  function hoursBetween(a,b){ // local (con 24:00→23:59)
    const norm = t=>{const [h,m]=t.split(':').map(Number);return (h===24&&m===0)?(24*60-1):(h*60+m);}
    return Math.max(0,(norm(b)-norm(a)))/60.0;
  }

  for (let i=0;i<assignments.length;i++){
    const slot = slotsV2[i];
    const dur = hoursBetween(slot.start, slot.end);
    for (const empId of assignments[i]){
      const r = mapIdx[empId];
      if (r===undefined) continue;
      hrs[r][slot.day] += dur;
      total[r] += dur;
    }
  }

  let html = '<table><thead><tr><th>Empleado</th>';
  for (let c=0;c<days.length;c++) html += `<th>${DAYS_ES[c]}</th>`;
  html += '<th>Total</th></tr></thead><tbody>';

  for (let r=0;r<emps.length;r++){
    html += `<tr><td class="emp">${emps[r].id}</td>`;
    for (let c=0;c<days.length;c++){
      const v = hrs[r][days[c]];
      const txt = v>0 ? v.toFixed(1) : '';
      const cls = v>0 ? ' class="hit"' : '';
      html += `<td${cls}>${txt}</td>`;
    }
    html += `<td><b>${total[r].toFixed(1)}</b></td></tr>`;
  }
  html += '</tbody></table>';
  document.getElementById('tableWrap').innerHTML = html;
}

// ----- Inicialización de la página -----
(function init(){
  const wrap = document.getElementById('days');
  for (let i=0;i<DAYS_EN.length;i++){
    const sec = daySection(i);
    wrap.appendChild(sec);
    // generar por defecto
    renderSlots(sec);
  }
})();

// ----- Calcular semana -----
document.getElementById('calcWeek').onclick = async () => {
  const {employees, slots, mins, tol} = collectWeekPayload();
  if (!slots.length){
    alert('No hay franjas seleccionadas en la semana.');
    return;
  }
  if (mins.length !== slots.length){
    alert('Alguna franja no tiene mínimo válido.');
    return;
  }
  const payload = { slots, min_per_slot: mins, employees, tolerance: tol };
  const res = await fetch('/solve/greedy_v2', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });
  const data = await res.json();

  // Pintar tabla y avisos
  renderMatrix(employees, slots, data.assignments || []);
  const warnBox = document.getElementById('warnings');
  if (data.warnings && data.warnings.length){
    warnBox.style.display = '';
    warnBox.textContent = data.warnings.join('\n');
  } else {
    warnBox.style.display = 'none';
    warnBox.textContent = '';
  }
};
</script>
</body>
</html>
