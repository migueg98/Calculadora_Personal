<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Cuadrantes — Wizard</title>
<style>
:root{--w:1160px}
body{font-family:system-ui,Segoe UI,Arial;margin:24px;max-width:var(--w)}
h1{margin:0 0 12px}
small.help{color:#555}
.step{border:1px solid #eee;border-radius:12px;padding:16px;margin:14px 0}
.row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
.col{display:flex;flex-direction:column;gap:6px}
label{font-weight:600}
select,input,button{font-size:14px;padding:8px}
select,input{min-width:120px}
table{border-collapse:collapse;width:100%;margin-top:16px}
th,td{border:1px solid #e3e3e3;padding:8px;text-align:center}
th{background:#fafafa}
td.emp{font-weight:700;text-align:left}
td.hit{background:#f3fbf3}
.warn{background:#fff9e6;border:1px solid #ffe08a;padding:10px;margin-top:10px;white-space:pre-wrap}
.btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
hr{border:none;border-top:1px solid #eee;margin:12px 0}
.daycard{padding:10px;border:1px solid #f0f0f0;border-radius:10px;margin:6px 0}
.daytitle{font-weight:700;color:#555;margin-bottom:6px}
.mono{font-family:ui-monospace,Menlo,Consolas,monospace}
</style>
</head>
<body>
<h1>Cuadrantes — Configuración por pasos</h1>

<!-- Paso 1: Horario del restaurante -->
<div class="step" id="step1">
  <h3>Paso 1 · Horario del restaurante</h3>
  <small class="help">Define hasta <b>dos rangos</b> por día (p. ej., 11:00–17:00 y 20:00–23:00). A partir de esto se generan <i>todas las franjas posibles</i>.</small>
  <div class="row">
    <div class="col">
      <label>Granularidad (min)</label>
      <select id="granularity">
        <option value="30">30</option>
        <option value="60" selected>60</option>
        <option value="120">120</option>
      </select>
    </div>
    <div class="col">
      <label>Duración mínima de franja (h)</label>
      <select id="minSlotH">
        <option>2</option><option selected>3</option><option>4</option>
      </select>
    </div>
    <div class="col">
      <label>Mínimo por franja (por defecto)</label>
      <select id="defaultMin">
        <option>0</option><option>1</option><option selected>2</option><option>3</option><option>4</option><option>5</option>
        <option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
      </select>
    </div>
  </div>

  <div id="days"></div>
</div>

<!-- Paso 2: Política del personal -->
<div class="step" id="step2">
  <h3>Paso 2 · Política del personal</h3>
  <div class="row">
    <div class="col" style="min-width:360px">
      <label>Empleados (IDs separados por coma)</label>
      <input id="emps" value="E1,E2,E3,E4,E5,E6,E7,E8,E9,E10">
    </div>
    <div class="col">
      <label>Objetivo horas/empleado</label>
      <select id="target"><option>20</option><option>30</option><option selected>40</option><option>45</option></select>
    </div>
    <div class="col">
      <label>Tolerancia ±h</label>
      <select id="tol"><option>0</option><option>1</option><option selected>2</option><option>3</option><option>4</option></select>
    </div>
  </div>
  <div class="row">
    <div class="col">
      <label>Turno partido</label>
      <select id="allowSplit">
        <option value="1">No (1 bloque)</option>
        <option value="2" selected>Sí (2 bloques)</option>
      </select>
    </div>
    <div class="col">
      <label>Mín. horas por día (si trabajan)</label>
      <select id="minDay"><option>2</option><option selected>3</option><option>4</option></select>
    </div>
    <div class="col">
      <label>Máx. horas por día</label>
      <select id="maxDay"><option>8</option><option selected>9</option><option>10</option></select>
    </div>
    <div class="col">
      <label>Descanso entre bloques (h)</label>
      <select id="minRest"><option>2</option><option selected>3</option><option>4</option></select>
    </div>
  </div>
</div>

<!-- Paso 3: Filtros del cuadrante -->
<div class="step" id="step3">
  <h3>Paso 3 · Filtros del cuadrante</h3>
  <div class="row">
    <div class="col">
      <label>Horizonte</label>
      <select id="weeks"><option>1</option><option selected>2</option><option>3</option><option>4</option></select>
    </div>
    <div class="col">
      <label>Días de descanso/sem (TODO)</label>
      <select id="daysOff"><option>0</option><option selected>2</option></select>
    </div>
    <div class="col">
      <label>Descansos consecutivos (TODO)</label>
      <select id="consecutive"><option>No</option><option>Sí</option></select>
    </div>
    <div class="col">
      <label>Medios días (TODO)</label>
      <select id="halfDays"><option>No</option><option>Sí</option></select>
    </div>
  </div>
  <div class="btns">
    <button id="run">Generar cuadrante</button>
  </div>
</div>

<!-- Resultado -->
<div id="tableWrap"></div>
<div id="warnings" class="warn" style="display:none"></div>

<script>
const DAYS_EN=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
const DAYS_ES=["Lun","Mar","Mié","Jue","Vie","Sáb","Dom"];
function pad2(n){return String(n).padStart(2,'0')}
function minutes(t){let [h,m]=t.split(":").map(Number);if(h===24&&m===0)return 24*60-1;return h*60+m}
function hoursBetween(a,b){return Math.max(0,(minutes(b)-minutes(a)))/60.0}
function timeOptions(step){const out=[];for(let m=0;m<=24*60;m+=step){const h=Math.floor(m/60),mm=m%60;out.push(`${pad2(h)}:${pad2(mm)}`)}return out}
function makeDayCard(idx){
  const en=DAYS_EN[idx], es=DAYS_ES[idx];
  const step=parseInt(document.getElementById('granularity').value||'60',10);
  const opts=timeOptions(step);
  const wrap=document.createElement('div'); wrap.className='daycard'; wrap.dataset.day=en;
  wrap.innerHTML=`
    <div class="daytitle">${es} <span class="mono">(${en})</span></div>
    <div class="row">
      <div class="col">
        <label>Rango 1 inicio</label><select class="s1">${opts.map(o=>`<option>${o}</option>`).join('')}</select>
      </div>
      <div class="col">
        <label>Rango 1 fin</label><select class="e1">${opts.map(o=>`<option>${o}</option>`).join('')}</select>
      </div>
      <div class="col">
        <label>Turno partido del local</label>
        <select class="parted"><option>No</option><option selected>Sí</option></select>
      </div>
      <div class="col">
        <label>Rango 2 inicio</label><select class="s2">${opts.map(o=>`<option>${o}</option>`).join('')}</select>
      </div>
      <div class="col">
        <label>Rango 2 fin</label><select class="e2">${opts.map(o=>`<option>${o}</option>`).join('')}</select>
      </div>
    </div>
    <small class="help">El sistema generará todas las franjas posibles dentro de estos rangos (≥ duración mínima) con el paso elegido.</small>
  `;
  // defaults razonables
  wrap.querySelector('.s1').value="11:00"; wrap.querySelector('.e1').value="17:00";
  wrap.querySelector('.s2').value="20:00"; wrap.querySelector('.e2').value="23:00";
  return wrap;
}
function collectScheduleWindows(){
  const cards=[...document.querySelectorAll('.daycard')];
  const out={}; for(const c of cards){
    const day=c.dataset.day;
    const s1=c.querySelector('.s1').value, e1=c.querySelector('.e1').value;
    const parted=c.querySelector('.parted').value==="Sí";
    const s2=c.querySelector('.s2').value, e2=c.querySelector('.e2').value;
    out[day]=[];
    if(minutes(e1)>minutes(s1)) out[day].push({start:s1,end:e1});
    if(parted && minutes(e2)>minutes(s2)) out[day].push({start:s2,end:e2});
  }
  return out; // {Mon:[{start,end},...], ...}
}
function generateSlotsFromWindows(windows, minH, stepMin){
  // devuelve [{day,start,end, min: defaultMin}, ...]
  const defaultMin=parseInt(document.getElementById('defaultMin').value||'2',10);
  const slots=[];
  for(const day of DAYS_EN){
    const wins=windows[day]||[];
    // generar marcas por ventana
    let marks=[];
    for(const w of wins){
      for(let m=minutes(w.start); m<=minutes(w.end); m+=stepMin){
        const h=Math.floor(m/60), mm=m%60; marks.push(`${pad2(h)}:${pad2(mm)}`);
      }
    }
    const uniq=[...new Set(marks)].sort((a,b)=>minutes(a)-minutes(b));
    for(let i=0;i<uniq.length-1;i++){
      for(let j=i+1;j<uniq.length;j++){
        const dur=hoursBetween(uniq[i], uniq[j]);
        if(dur>=minH){
          // solo si está contenido en alguna ventana del día
          if(wins.some(w=>minutes(uniq[i])>=minutes(w.start)&&minutes(uniq[j])<=minutes(w.end))){
            slots.push({day,start:uniq[i],end:uniq[j],min:defaultMin});
          }
        }
      }
    }
  }
  return slots;
}
function buildEmployees(){
  const ids=document.getElementById('emps').value.trim().split(',').map(x=>x.trim()).filter(Boolean);
  const target=parseFloat(document.getElementById('target').value||'40');
  const tol=parseFloat(document.getElementById('tol').value||'2');
  const maxBlocks=parseInt(document.getElementById('allowSplit').value||'2',10);
  const minDay=parseFloat(document.getElementById('minDay').value||'3');
  const maxDay=parseFloat(document.getElementById('maxDay').value||'9');
  const minRest=parseFloat(document.getElementById('minRest').value||'3');
  const emps=ids.map(id=>({
    id, target_hours:target,
    max_hours_per_day:maxDay,
    max_blocks_per_day:maxBlocks,
    min_hours_per_day:minDay,
    min_rest_between_blocks:minRest,
    availability:{} // se rellenará por ventanas del local
  }));
  return {emps, tol};
}
function attachAvailability(emps, windows){
  for(const e of emps){
    e.availability={};
    for(const d of DAYS_EN){
      if(windows[d] && windows[d].length){
        e.availability[d]=windows[d].map(w=>({start:w.start,end:w.end}));
      }
    }
  }
}
function weeksRepeat(n, slots, mins){
  // duplica las semanas cambiando solo el "día" → Week1-Mon..Week2-Mon (usamos mismo nombre de día para el solver)
  // El solver no necesita cambiar el nombre; solo repetimos arrays n veces.
  const repSlots=[]; const repMins=[];
  for(let k=0;k<n;k++){ repSlots.push(...slots); repMins.push(...mins); }
  return {slots:repSlots, mins:repMins};
}
function renderMatrix(emps, slotsV2, assignments){
  const days=DAYS_EN; const mapIdx=Object.fromEntries(emps.map((e,i)=>[e.id,i]));
  const hrs=Array.from({length:emps.length},()=>Object.fromEntries(days.map(d=>[d,0])));
  const total=new Array(emps.length).fill(0);
  for(let i=0;i<assignments.length;i++){
    const sl=slotsV2[i]; const dur=hoursBetween(sl.start,sl.end);
    for(const empId of assignments[i]){ const r=mapIdx[empId]; if(r===undefined)continue; hrs[r][sl.day]+=dur; total[r]+=dur; }
  }
  let html='<table><thead><tr><th>Empleado</th>'; for(const d of days) html+=`<th>${d}</th>`; html+='<th>Total</th></tr></thead><tbody>';
  for(let r=0;r<emps.length;r++){
    html+=`<tr><td class="emp">${emps[r].id}</td>`;
    for(const d of days){ const v=hrs[r][d]; const txt=v>0? v.toFixed(1):''; const cls=v>0?' class="hit"':''; html+=`<td${cls}>${txt}</td>`; }
    html+=`<td><b>${total[r].toFixed(1)}</b></td></tr>`;
  }
  html+='</tbody></table>'; document.getElementById('tableWrap').innerHTML=html;
}
function initDays(){
  const box=document.getElementById('days'); box.innerHTML='';
  for(let i=0;i<7;i++) box.appendChild(makeDayCard(i));
}
document.getElementById('granularity').onchange=initDays;
initDays();

document.getElementById('run').onclick=async ()=>{
  // Paso 1 → generar franjas
  const windows=collectScheduleWindows();
  const minH=parseFloat(document.getElementById('minSlotH').value||'3');
  const stepMin=parseInt(document.getElementById('granularity').value||'60',10);
  const slotsBase=generateSlotsFromWindows(windows, minH, stepMin); // [{day,start,end,min}]
  if(!slotsBase.length){ alert('No hay franjas posibles con la configuración actual.'); return; }
  const minsBase=slotsBase.map(s=>s.min);

  // Paso 2 → empleados + reglas
  const {emps, tol}=buildEmployees();
  attachAvailability(emps, windows);

  // Paso 3 → horizonte semanas
  const nWeeks=parseInt(document.getElementById('weeks').value||'2',10);
  const {slots, mins}=weeksRepeat(nWeeks, slotsBase.map(({day,start,end})=>({day,start,end})), minsBase);

  // Llamada al solver
  const payload={
    slots,
    min_per_slot: mins,
    employees: emps,
    tolerance: tol
  };
  const res=await fetch('/solve/greedy_v2',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
  const data=await res.json();

  renderMatrix(emps, slots, data.assignments||[]);
  const warn=document.getElementById('warnings');
  if(data.warnings && data.warnings.length){ warn.style.display=''; warn.textContent=data.warnings.join('\n'); }
  else { warn.style.display='none'; warn.textContent=''; }
};
</script>
</body>
</html>
